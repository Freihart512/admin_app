## Entidad: Factura

Represents the formal tax document (invoice) generated by the system for a specific monthly Payment. It details the amount owed by the Tenant to the Propietario for the rental of a Property and is directly linked to the corresponding Payment record. The generation of a Payment triggers the creation of an Invoice.

### Propiedades del Sistema


- `invoice_id` (Unique Identifier): A unique system-generated identifier for the invoice.
- `payment_id` (Foreign Key): A foreign key linking to the Payment this invoice represents.
- `invoice_number`: A unique identifier for the invoice (system-generated).
- `issue_date`: The date the invoice was generated (first day of the month).
- `due_date`: The date the payment is due (based on the contract's payment due day, inherited from the Payment).
- `amount`: The amount of the payment for this invoice.
- `fees_taxes` (Optional): Any additional fees or taxes.
- `total_amount`: The total amount due.
- `status`: The current status of the invoice (e.g., 'pending_timbrado', 'timbrada', 'cancelada', 'error').
- `cfdi_data` (JSON, Optional): Stores the data returned by the SW Sapien API after successful timbrado, including the UUID, cadena original, sello, etc.
- `created_at`: Timestamp (date and time) when the invoice record was created.
- `deleted_at` (Timestamp, Optional): Timestamp (date and time) when the invoice record was soft-deleted.

### 🔁 Casos de Uso Relacionados
- [[📄 CasosDeUso/CU09_integracion_swsapien]]
- [[📄 CasosDeUso/CU06_facturacion_automatica]]
- [[📄 CasosDeUso/CU08_resumen_historial]]
- [[📄 CasosDeUso/CU07_notificaciones_email]]

### Ciclo de Vida Típico

1.  **Pending Timbrado**: The invoice record is created automatically by the system based on a Payment.
2.  **Timbrada**: The invoice is successfully processed by the SW Sapien API and receives its fiscal validity.
3.  **Error**: The timbrado process fails. The system should log the error and potentially allow for manual retry or review.
4.  **Cancelada**: The invoice is canceled in the system and with the SAT via SW Sapien.

Note: Statuses like 'unpaid', 'paid', 'overdue' are typically tracked at the Payment level, not the Invoice level, as the Invoice is the fiscal document, while the Payment tracks the monetary transaction.

### 🧑‍💻 User Stories Relacionadas
- [[🧑‍💻 UserStories/US14_generar_factura_automaticamente]]
- [[🧑‍💻 UserStories/US15_listar_facturas]]
- [[🧑‍💻 UserStories/US19_listar_facturas]]
- [[🧑‍💻 UserStories/US20_listar_facturas_admin]]

### 👥 Roles Relacionados
- [[👥 Usuarios/propietario]]
- [[👥 Usuarios/inquilino]]
- [[👥 Usuarios/admin]]
- [[👥 Usuarios/contador]]

### 🏠 Entidades Relacionadas
- [[🏠 Entidades/pago]]