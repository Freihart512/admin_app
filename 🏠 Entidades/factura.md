## Entidad: Factura

Represents the formal tax document (invoice) generated by the system for a specific monthly Payment. It details the amount owed by the Tenant to the Propietario for the rental of a Property and is directly linked to the corresponding Payment record. The generation of a Payment triggers the creation of an Invoice.

### Propiedades del Sistema


- `invoice_id` (Unique Identifier): A unique system-generated identifier for the invoice.
- `payment_id` (Foreign Key): A foreign key linking to the Payment this invoice represents.
- `invoice_number`: A unique identifier for the invoice (system-generated).
- `issue_date`: The date the invoice was generated (first day of the month).
- `due_date`: The date the payment is due (based on the contract's payment due day, inherited from the Payment).
- `amount`: The amount of the payment for this invoice.
- `fees_taxes` (Optional): Any additional fees or taxes.
- `total_amount`: The total amount due.
- `status`: The current status of the invoice (e.g., 'pending_timbrado', 'timbrada', 'cancelada', 'error').
- `cfdi_data` (JSON, Optional): Stores the data returned by the SW Sapien API after successful timbrado, including the UUID, cadena original, sello, etc.
- `created_at`: Timestamp (date and time) when the invoice record was created.
- `deleted_at` (Timestamp, Optional): Timestamp (date and time) when the invoice record was soft-deleted.

### 🔁 Casos de Uso Relacionados
- [[📄 CasosDeUso/CU09_Integracion_SW_Sapien]]
- [[📄 CasosDeUso/CU06_Facturacion_Automatica]]
- [[📄 CasosDeUso/CU08_Resumen_Historial]]
- [[📄 CasosDeUso/CU07_Notificaciones_Email]]

### Ciclo de Vida Típico

1.  **Pending Timbrado**: The invoice record is created automatically by the system based on a Payment.
2.  **Timbrada**: The invoice is successfully processed by the SW Sapien API and receives its fiscal validity.
3.  **Error**: The timbrado process fails. The system should log the error and potentially allow for manual retry or review.
4.  **Cancelada**: The invoice is canceled in the system and with the SAT via SW Sapien.

Note: Statuses like 'unpaid', 'paid', 'overdue' are typically tracked at the Payment level, not the Invoice level, as the Invoice is the fiscal document, while the Payment tracks the monetary transaction.

### 🧑‍💻 User Stories Relacionadas

## Manejo de Errores de Timbrado (status: 'error')

Cuando una `Factura` cambia al estado `'error'` debido a un fallo en la integración con la API de SW Sapien, el sistema debe:

1.  Registrar un log de nivel `'ERROR'` detallado en la entidad `Log`, incluyendo el `invoice_id` relacionado, el mensaje de error recibido de la API de SW Sapien (si está disponible) y la marca de tiempo del fallo. Esto se relaciona con la [[🏠 Entidades/log.md]] y el [[📄 CasosDeUso/CU10_logs_y_errores.md]].
2.  Marcar la `Factura` con el estado `'error'`.
 3.  Enviar una notificación de alerta al rol de `admin` (según la [[🧑‍💻 UserStories/US24_Alerta_fallo_de_facura]]), informando sobre el fallo de timbrado para esa factura específica.

**Acciones Posteriores (Reintento/Revisión Manual):**

*   El sistema permitirá al `admin` intentar nuevamente el proceso de timbrado para una `Factura` en estado `'error'` a través de una acción manual.
*   Al intentar el reintento manual, el sistema intentará nuevamente enviar la solicitud de timbrado a la API de SW Sapien.
*   Si el reintento es exitoso, el estado de la `Factura` cambiará a `'timbrada'` y se actualizará el campo `cfdi_data`.
*   Si el reintento falla, se registrará un nuevo log de error y la `Factura` permanecerá en estado `'error'`.
*   La interfaz de administración (aunque fuera del alcance V1.0) deberá proporcionar una forma clara para que los administradores identifiquen las facturas en estado `'error'` y ejecuten el reintento manual.


### 🧑‍💻 User Stories Relacionadas
- [[🧑‍💻 UserStories/US14_Generar_Facturas_Automaticamente]]
- [[🧑‍💻 UserStories/US15_listar_facturas]]
- [[🧑‍💻 UserStories/US19_Listar_Facturas_propietario]]
- [[🧑‍💻 UserStories/US20_Listar_facturas_admin]]

### 👥 Roles Relacionados
- [[👥 Usuarios/Propietario]]
- [[👥 Usuarios/Inquilino]]
- [[👥 Usuarios/Admin]]
- [[👥 Usuarios/Contador]]

### 🏠 Entidades Relacionadas
- [[🏠 Entidades/pago]]
- [[🏠 Entidades/log.md]]
- [[🏠 Entidades/notificacion.md]]